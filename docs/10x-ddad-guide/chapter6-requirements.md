# 第六章:需求细化

> **本章导读**
>
> 学习如何将PRD进一步细化为可执行的需求文档,掌握用户故事编写的INVEST原则,理解验收标准的定义方法,以及如何识别和管理非功能需求。

---

## 6.1 产品需求文档(PRD.md)完善

### 从初稿到可执行PRD

CodeGuideDev生成的PRD是一个很好的起点,但通常需要进一步细化才能真正驱动AI开发。

**初稿PRD的常见问题**:
```
❌ 功能描述过于抽象: "AI智能分析会议内容"
❌ 验收标准不够具体: "系统响应速度快"
❌ 技术实现缺乏细节: "使用AI API"
❌ 边界条件未说明: 文件大小限制?支持的格式?
```

**可执行PRD的标准**:
```
✅ 功能描述具体可测: "使用GPT-4提取会议中的架构决策,格式为结构化JSON"
✅ 验收标准可量化: "API响应时间 < 500ms (P95)"
✅ 技术实现明确: "使用OpenAI GPT-4 API,模型gpt-4-turbo-preview,温度0.3"
✅ 边界条件清晰: "支持MP3/WAV/M4A,最大200MB,时长不超过2小时"
```

---

### PRD完善的五个维度

#### 1. 功能描述完善

**从抽象到具体**:

```markdown
❌ 初稿 (抽象):
### F3: 智能内容提取
用户可以查看AI提取的会议要点。

✅ 细化后 (具体):
### F3: 智能内容提取

**功能概述**:
系统使用GPT-4分析转录文本,自动识别并提取以下技术要点:

1. **架构决策 (Architecture Decisions)**
   - 识别: "我们决定...", "选择...", "采用..."等决策性语句
   - 提取: 决策内容、决策理由、影响范围
   - 格式:
   ```json
   {
     "type": "architecture_decision",
     "decision": "采用微服务架构",
     "rationale": "提高系统可扩展性和团队独立性",
     "impact": "需要引入API Gateway和服务发现",
     "timestamp": "00:15:32"
   }
   ```

2. **技术权衡 (Technical Trade-offs)**
   - 识别: "优点是...", "缺点是...", "A vs B"等对比讨论
   - 提取: 方案A、方案B、各自优缺点、最终选择
   - 格式:
   ```json
   {
     "type": "trade_off",
     "option_a": "PostgreSQL",
     "option_b": "MongoDB",
     "pros_a": ["强一致性", "成熟的事务支持"],
     "cons_a": ["水平扩展复杂"],
     "pros_b": ["灵活schema", "易扩展"],
     "cons_b": ["弱一致性", "复杂查询性能差"],
     "final_choice": "PostgreSQL",
     "timestamp": "00:22:15"
   }
   ```

3. **行动项 (Action Items)**
   - 识别: "谁负责...", "需要做...", "下周前..."等任务分配
   - 提取: 任务描述、负责人、截止日期(如果提到)
   - 格式:
   ```json
   {
     "type": "action_item",
     "task": "完成用户认证模块的API设计",
     "assignee": "张三",
     "deadline": "下周五",
     "priority": "high",
     "timestamp": "00:45:20"
   }
   ```

4. **代码片段 (Code Snippets)**
   - 识别: "代码是...", "API定义为...", "函数签名..."等技术细节
   - 提取: 代码内容、编程语言、上下文说明
   - 格式:
   ```json
   {
     "type": "code_snippet",
     "language": "typescript",
     "code": "interface User { id: string; email: string; }",
     "context": "用户接口定义",
     "timestamp": "00:30:10"
   }
   ```

**输入**: 转录文本(来自F2)
**输出**: 结构化JSON数组,包含上述4类要点
**API调用**: OpenAI GPT-4 (gpt-4-turbo-preview, temperature=0.3)
**预期处理时间**: < 30秒(对于30分钟会议)

**Prompt Engineering**:
[详见 docs/03-implementation/prompts/content-extraction.md]

**边界条件**:
- 如果转录文本 < 100字: 返回空数组,提示"会议内容太短,无法提取有效信息"
- 如果没有识别到任何技术要点: 返回空数组,提示"未识别到明确的技术决策或行动项"
- 如果API调用失败: 重试3次,失败后提示用户并记录日志
```

**改进要点**:
- ✅ 功能细分为4个子功能,每个都有明确定义
- ✅ 数据格式用JSON Schema清晰说明
- ✅ 技术实现细节(API模型、温度参数)明确
- ✅ 边界条件和异常情况都考虑到了

---

#### 2. 验收标准量化

**从主观到客观**:

```markdown
❌ 初稿 (主观):
验收标准:
- [ ] 提取准确
- [ ] 速度快
- [ ] 用户体验好

✅ 细化后 (客观可测):
验收标准:
- [ ] **准确性**: 在10个测试会议中,架构决策识别准确率 ≥ 85%
  - 测试方法: 人工标注ground truth,计算Precision和Recall
  - 评估数据: 使用docs/04-testing/test-data/sample-meetings/目录中的录音

- [ ] **完整性**: 在10个测试会议中,行动项召回率 ≥ 90%
  - 定义: 人工能识别的行动项中,AI识别出的比例

- [ ] **性能**: 30分钟会议的处理时间 < 30秒 (P95)
  - 测试方法: 使用docs/04-testing/scripts/performance-test.sh
  - 目标: 95%的请求在30秒内完成

- [ ] **错误率**: API调用失败率 < 1%
  - 定义: (失败次数 / 总调用次数) × 100%
  - 包含: 超时、API错误、解析失败等所有失败情况

- [ ] **用户满意度**: 在5个早期用户测试中,对提取质量的评分 ≥ 4/5
  - 测试方法: 让用户上传真实会议,评价结果的有用性
  - 问题: "这个纪要对你有多大帮助?(1-5分)"
```

**量化技巧**:
- ✅ 用具体数字替代形容词(85% vs "准确")
- ✅ 定义测试方法和数据集
- ✅ 使用百分位数(P95, P99)而非平均值
- ✅ 包含用户主观评价(但也要量化)

---

#### 3. 技术实现细化

**从框架到代码级别**:

```markdown
❌ 初稿 (框架级):
技术实现: 使用OpenAI API进行AI分析

✅ 细化后 (代码级):
技术实现:

**API调用**:
```typescript
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

async function extractInsights(transcript: string): Promise<Insight[]> {
  const response = await openai.chat.completions.create({
    model: 'gpt-4-turbo-preview',
    messages: [
      {
        role: 'system',
        content: SYSTEM_PROMPT, // 见下文
      },
      {
        role: 'user',
        content: `请分析以下会议转录,提取技术要点:\n\n${transcript}`,
      },
    ],
    temperature: 0.3, // 低温度保证输出稳定性
    max_tokens: 2000,
    response_format: { type: 'json_object' }, // 强制JSON输出
  });

  const result = JSON.parse(response.choices[0].message.content);
  return validateAndTransform(result); // 验证并转换为Insight[]类型
}
```

**System Prompt**:
```
你是一个专业的技术会议分析助手。你的任务是从会议转录中提取关键技术信息。

请严格按照以下JSON格式输出:
{
  "architecture_decisions": [
    {
      "decision": "具体决策内容",
      "rationale": "决策理由",
      "impact": "影响范围",
      "timestamp": "时间戳(如果能推断)"
    }
  ],
  "trade_offs": [...],
  "action_items": [...],
  "code_snippets": [...]
}

注意:
1. 只提取明确讨论的内容,不要推测
2. 时间戳格式: "HH:MM:SS"
3. 如果某类信息没有,返回空数组[]
4. 代码片段要保留原始格式
```

**错误处理**:
```typescript
try {
  const insights = await extractInsights(transcript);
  return insights;
} catch (error) {
  if (error instanceof OpenAI.APIError) {
    if (error.status === 429) {
      // 速率限制,等待重试
      await sleep(5000);
      return extractInsights(transcript); // 递归重试
    } else if (error.status === 500) {
      // OpenAI服务器错误
      logger.error('OpenAI server error', { error });
      throw new ServiceUnavailableError('AI service temporarily unavailable');
    }
  }
  // 其他未知错误
  logger.error('Unexpected error in extractInsights', { error });
  throw error;
}
```

**成本估算**:
- 模型: gpt-4-turbo-preview
- 输入: ~3000 tokens (30分钟会议转录)
- 输出: ~500 tokens (结构化结果)
- 成本: $0.01 per 1K input tokens + $0.03 per 1K output tokens
- 单次调用成本: (3 × $0.01) + (0.5 × $0.03) = $0.045
- 月度成本(100次调用): $4.50
```

---

#### 4. 依赖关系明确

**功能依赖图**:

```markdown
依赖关系:

F1 (音频上传) → F2 (AI转录) → F3 (智能提取) → F4 (Dashboard展示)
                                                          ↓
                                                      F6 (Notion导出)
F5 (用户认证) ←────────────────────────────────────────┘

依赖说明:
- F2依赖F1: 必须先上传音频,才能转录
- F3依赖F2: 必须先转录成文字,才能提取要点
- F4依赖F3: 必须先提取要点,才能在Dashboard展示
- F6依赖F4: 必须先有Dashboard展示,才能导出
- F5独立: 用户认证不依赖其他功能,但其他功能需要认证

技术依赖:
- OpenAI Whisper API (F2)
- OpenAI GPT-4 API (F3)
- Supabase Auth (F5)
- Supabase Storage (F1)
- Supabase Database (F4, F6)
- Notion API (F6)

外部依赖风险:
- OpenAI API可用性: 99.9% SLA,备选方案: Anthropic Claude
- Notion API稳定性: 无SLA保证,备选方案: Markdown下载
```

---

#### 5. 非功能需求补充

**从功能到完整系统**:

```markdown
## 非功能需求 (NFRs)

### 性能需求 (Performance)
| 指标 | 目标 | 测量方法 |
|------|-----|---------|
| 音频上传速度 | > 1MB/s | 上传200MB文件耗时 < 200秒 |
| 转录处理时间 | < 1x实时 | 30分钟音频在30分钟内完成 |
| 提取处理时间 | < 30秒 | GPT-4调用耗时 < 30秒(P95) |
| Dashboard加载 | < 2秒 | 首屏加载时间 < 2秒(P95) |
| API响应时间 | < 500ms | 查询纪要API响应 < 500ms(P95) |

### 可用性需求 (Availability)
- **系统可用性**: > 99.5% (依赖Supabase和Vercel SLA)
- **计划维护窗口**: 每月第一个周日凌晨2-4点(PST)
- **故障恢复时间**: < 1小时(RTO)
- **数据恢复点**: < 1小时(RPO, Supabase自动备份)

### 可扩展性需求 (Scalability)
- **用户规模**: 支持0-1000并发用户无架构调整
- **数据增长**: 支持每用户100个会议,每个会议200MB
- **并发处理**: 支持10个同时转录任务
- **数据库**: PostgreSQL支持1TB数据(Supabase Pro计划)

### 安全需求 (Security)
- **认证**: 邮箱+密码,bcrypt加密(cost factor 10)
- **授权**: Supabase RLS确保用户只能访问自己的数据
- **传输加密**: HTTPS (TLS 1.3)
- **存储加密**: Supabase自动加密存储
- **API密钥**: 环境变量存储,不提交到代码库
- **速率限制**:
  - 登录: 5次/小时/IP
  - 上传: 10次/小时/用户
  - API查询: 100次/分钟/用户

### 可用性 (Usability)
- **学习曲线**: 新用户5分钟内完成首次会议转录
- **错误提示**: 所有错误都有用户友好的提示信息
- **帮助文档**: 每个功能都有inline help或tooltip
- **响应式**: 支持Desktop(1920×1080), Tablet(768×1024), Mobile(375×667)
- **可访问性**: 符合WCAG 2.1 AA标准
  - 键盘导航
  - 屏幕阅读器兼容
  - 颜色对比度 ≥ 4.5:1

### 可维护性 (Maintainability)
- **代码规范**: ESLint + Prettier,自动格式化
- **测试覆盖率**: > 80%单元测试覆盖率
- **文档完整性**: 所有公共函数有JSDoc注释
- **日志记录**: 所有错误和关键操作记录到Supabase Logs
- **监控**: Vercel Analytics + Supabase Dashboard

### 兼容性 (Compatibility)
- **浏览器**: Chrome 90+, Firefox 90+, Safari 14+, Edge 90+
- **音频格式**: MP3, WAV, M4A (其他格式提示不支持)
- **文件大小**: 最大200MB
- **API版本**: 遵循语义化版本(Semantic Versioning)
```

---

## 6.2 用户故事(user-stories.md)编写

### 什么是用户故事?

**用户故事(User Story)**是从用户视角描述功能的一种方法,格式:

```
作为 [角色]
我想要 [功能]
以便于 [价值/目标]
```

**为什么需要用户故事?**
- 🎯 **用户中心**: 强制从用户角度思考,而非技术实现
- 🤝 **沟通工具**: 团队和AI都能理解的清晰语言
- ✅ **验收依据**: 明确的"完成定义"(Definition of Done)
- 📊 **优先级排序**: 容易比较不同故事的价值

---

### INVEST原则

好的用户故事应该遵循**INVEST**原则:

#### I - Independent (独立性)

```markdown
❌ 不独立:
US-001: 作为用户,我想要上传音频文件
US-002: 作为用户,我想要看到上传进度 (依赖US-001)

✅ 独立:
US-001: 作为用户,我想要上传音频文件并看到上传进度,以便于知道上传状态

理由: 将相关功能合并为一个故事,减少依赖
```

#### N - Negotiable (可协商)

```markdown
❌ 过于具体(不可协商):
作为用户,我想要使用React Dropzone组件上传文件,拖拽时显示蓝色边框

✅ 可协商:
作为用户,我想要通过拖拽的方式上传音频文件,以便于操作更便捷

理由: 留出技术实现的灵活性,AI可以选择最佳实现方式
```

#### V - Valuable (有价值)

```markdown
❌ 无明确价值:
作为开发者,我想要使用TypeScript编写代码

✅ 有价值:
作为用户,我想要上传完成后立即看到转录进度,以便于知道还需要等待多久

理由: 用户故事应该从用户价值出发,技术选择是实现手段
```

#### E - Estimable (可估算)

```markdown
❌ 无法估算:
作为用户,我想要一个完美的AI分析系统

✅ 可估算:
作为用户,我想要AI提取会议中的架构决策(包括决策内容、理由、影响),以便于快速回顾技术选型

理由: 具体、可测,开发者可以估算工作量
```

#### S - Small (小型化)

```markdown
❌ 太大:
作为用户,我想要一个完整的会议管理系统

✅ 小型化:
- US-001: 作为用户,我想要上传音频文件
- US-002: 作为用户,我想要看到AI转录结果
- US-003: 作为用户,我想要查看提取的架构决策

理由: 每个故事1-3天可完成,便于迭代和追踪进度
```

#### T - Testable (可测试)

```markdown
❌ 不可测试:
作为用户,我想要系统运行流畅

✅ 可测试:
作为用户,我想要Dashboard在2秒内加载完成,以便于快速查看纪要

验收标准:
- [ ] 使用Lighthouse测试,首屏加载 < 2秒
- [ ] 使用Playwright E2E测试,页面加载成功率 100%

理由: 有明确的测试方法和成功标准
```

---

### 用户故事模板

**标准模板** (user-stories.md):

```markdown
# 用户故事集 (User Stories)

## Epic 1: 会议录音上传与转录

### US-001: 上传音频文件并查看进度

**作为** Tech Lead
**我想要** 上传会议录音文件并实时看到上传进度
**以便于** 我知道文件是否成功上传,以及还需要等待多久

**验收标准**:
- [ ] 我可以通过拖拽或点击按钮选择音频文件
- [ ] 支持的格式: MP3, WAV, M4A
- [ ] 文件大小限制: 最大200MB
- [ ] 上传过程中显示进度条(百分比)
- [ ] 上传完成后显示成功提示
- [ ] 上传失败时显示错误信息和重试按钮
- [ ] 错误信息用户友好(例: "文件太大,请上传小于200MB的文件")

**技术实现提示**:
- 使用Supabase Storage上传
- 前端使用`@supabase/storage-js`的上传进度回调
- 错误处理: 网络失败、文件格式错误、大小超限

**优先级**: P0 (Must Have)
**估算工作量**: 1天
**依赖**: F5 (用户认证)

**测试场景**:
1. 正常上传: 拖拽一个50MB的MP3文件,验证进度条和成功提示
2. 格式错误: 上传PDF文件,验证错误提示
3. 大小超限: 上传300MB文件,验证错误提示
4. 网络中断: 上传过程中断网,验证重试功能

---

### US-002: 查看AI转录结果

**作为** Tech Lead
**我想要** 在音频上传后自动获得转录文本
**以便于** 我可以快速浏览会议内容,而不需要重听录音

**验收标准**:
- [ ] 音频上传完成后,系统自动开始转录
- [ ] 转录过程中显示"正在转录..."和预计时间
- [ ] 转录完成后,我可以看到完整的文本
- [ ] 文本有自动断句和标点符号
- [ ] 转录准确率 > 90% (基于测试音频)
- [ ] 30分钟音频的转录时间 < 30分钟
- [ ] 转录失败时显示错误信息和重试选项

**用户旅程**:
```
1. 用户上传音频 → 看到"上传成功,正在转录..."
2. 等待1-30分钟(取决于音频长度)
3. 收到通知(邮件或页面刷新提示): "转录完成!"
4. 点击查看转录文本
5. 文本显示在Dashboard,可滚动查看
```

**技术实现提示**:
- 使用OpenAI Whisper API (whisper-1模型)
- 异步处理: 上传完成后触发后台任务
- 使用Supabase Realtime订阅任务状态更新
- 邮件通知: 使用Supabase Edge Functions + Resend API

**优先级**: P0 (Must Have)
**估算工作量**: 1.5天
**依赖**: US-001 (音频上传)

**测试场景**:
1. 短音频(5分钟): 验证快速转录
2. 长音频(60分钟): 验证长时间处理
3. 噪音音频: 验证转录质量降级时的处理
4. API失败: 模拟Whisper API错误,验证重试和错误提示

---

### US-003: 查看结构化会议纪要

**作为** Tech Lead
**我想要** 看到AI自动提取的架构决策、技术权衡和行动项
**以便于** 我不需要手动整理笔记,可以快速抓住会议重点

**验收标准**:
- [ ] 纪要分为明确的章节:
  - 架构决策 (Architecture Decisions)
  - 技术权衡 (Technical Trade-offs)
  - 行动项 (Action Items)
  - 代码片段 (Code Snippets)
- [ ] 每个架构决策包含: 决策内容、理由、影响范围
- [ ] 每个技术权衡包含: 方案A、方案B、各自优缺点、最终选择
- [ ] 每个行动项包含: 任务描述、负责人(如果提到)、截止日期(如果提到)
- [ ] 代码片段有语法高亮
- [ ] 每个要点都有时间戳,点击可跳转到音频对应位置(v1.1功能)
- [ ] 如果某个章节为空,显示"未识别到XX信息"而非留空

**UI Mock** (参考):
```
╔═══════════════════════════════════════════╗
║ 会议纪要: 系统架构讨论 - 2025-10-12      ║
╠═══════════════════════════════════════════╣
║ 📋 架构决策 (2项)                         ║
║ ┌─────────────────────────────────────┐  ║
║ │ ✓ 采用微服务架构                     │  ║
║ │   理由: 提高系统可扩展性              │  ║
║ │   影响: 需要引入API Gateway           │  ║
║ │   时间: 00:15:32                     │  ║
║ └─────────────────────────────────────┘  ║
║                                           ║
║ ⚖️ 技术权衡 (1项)                         ║
║ ┌─────────────────────────────────────┐  ║
║ │ PostgreSQL vs MongoDB                │  ║
║ │ ✓ 选择: PostgreSQL                   │  ║
║ │   优点: 强一致性、事务支持            │  ║
║ │   缺点: 水平扩展复杂                  │  ║
║ └─────────────────────────────────────┘  ║
║                                           ║
║ ✅ 行动项 (3项)                           ║
║ ┌─────────────────────────────────────┐  ║
║ │ □ 完成API设计文档                    │  ║
║ │   负责人: 张三                        │  ║
║ │   截止: 下周五                        │  ║
║ └─────────────────────────────────────┘  ║
╚═══════════════════════════════════════════╝
```

**技术实现提示**:
- 使用GPT-4提取结构化信息
- 前端使用Shadcn/ui的Card和Accordion组件
- 代码高亮使用Prism.js或react-syntax-highlighter

**优先级**: P0 (Must Have)
**估算工作量**: 2天
**依赖**: US-002 (转录完成)

**测试场景**:
1. 典型技术会议: 验证所有4类信息都能提取
2. 纯讨论会议: 验证只有决策和行动项,没有代码
3. 短会议(<5分钟): 验证"内容太短"提示
4. 非技术会议: 验证能识别这不是技术会议

---

### US-004: 导出纪要到Notion

**作为** Tech Lead
**我想要** 将AI生成的纪要一键导出到Notion
**以便于** 我可以在团队的知识库中保存和分享会议纪要

**验收标准**:
- [ ] Dashboard上有"导出到Notion"按钮
- [ ] 点击后生成Notion-friendly格式的Markdown
- [ ] 包含所有结构化信息(决策、权衡、行动项、代码)
- [ ] 格式美观,使用Notion的block类型(heading, bullet list, code block)
- [ ] 提供复制到剪贴板功能
- [ ] 提示用户: "已复制,请粘贴到Notion页面"
- [ ] (v1.1) OAuth集成,直接创建Notion page

**Notion格式示例**:
```markdown
# 会议纪要: 系统架构讨论
**日期**: 2025-10-12
**时长**: 45分钟

---

## 📋 架构决策

### 决策1: 采用微服务架构
- **决策内容**: 将单体应用拆分为多个独立的微服务
- **决策理由**: 提高系统可扩展性和团队独立性
- **影响范围**: 需要引入API Gateway和服务发现机制
- **时间戳**: 00:15:32

---

## ⚖️ 技术权衡

### PostgreSQL vs MongoDB
- **最终选择**: ✅ PostgreSQL
- **PostgreSQL优点**:
  - 强一致性保证
  - 成熟的事务支持
- **PostgreSQL缺点**:
  - 水平扩展相对复杂
- **MongoDB优点**:
  - 灵活的schema设计
  - 易于水平扩展
- **MongoDB缺点**:
  - 弱一致性
  - 复杂查询性能较差

---

## ✅ 行动项

- [ ] **完成用户认证模块的API设计** (张三, 下周五)
- [ ] **搭建开发环境** (李四, 本周内)
- [ ] **调研API Gateway方案** (王五, 下周三)

---

## 💻 代码片段

```typescript
// 用户接口定义
interface User {
  id: string;
  email: string;
  createdAt: Date;
}
```

*时间戳: 00:30:10*

---

> 📝 本纪要由TechMeet AI自动生成
```

**技术实现提示**:
- 使用模板引擎(Handlebars/EJS)生成Markdown
- 复制到剪贴板: `navigator.clipboard.writeText()`
- v1.1 Notion OAuth: 使用Notion API创建page

**优先级**: P0 (Must Have - MVP用复制粘贴, v1.1 OAuth)
**估算工作量**: 1天(MVP), +0.5天(OAuth)
**依赖**: US-003 (结构化纪要)

---

### US-005: 实时录音 (v1.1)

**作为** Tech Lead
**我想要** 在浏览器中直接录音,而不需要先录音再上传
**以便于** 我可以更便捷地记录会议

**验收标准**:
- [ ] Dashboard有"开始录音"按钮
- [ ] 点击后请求麦克风权限
- [ ] 录音过程中显示时长和波形
- [ ] 可以暂停和继续录音
- [ ] 录音完成后自动保存到Supabase Storage
- [ ] 自动开始转录流程
- [ ] 支持Chrome, Firefox, Safari最新版本

**技术实现提示**:
- 使用MediaRecorder API
- 实时显示波形: Web Audio API
- 格式: WebM (Chrome/Firefox) or MP4 (Safari)

**优先级**: P1 (Should Have - v1.1)
**估算工作量**: 1.5天
**依赖**: US-001 (上传流程)

---

## Epic 2: 用户管理

### US-006: 用户注册和登录

**作为** 新用户
**我想要** 使用邮箱和密码注册账号
**以便于** 我可以保存我的会议纪要

**验收标准**:
- [ ] 注册页面包含: 邮箱、密码、确认密码
- [ ] 密码强度要求: 至少8位,包含大小写字母和数字
- [ ] 注册成功后发送验证邮件
- [ ] 用户可以使用邮箱+密码登录
- [ ] 登录失败3次后显示验证码(防止暴力破解)
- [ ] "忘记密码"功能: 发送重置链接到邮箱

**技术实现提示**:
- 使用Supabase Auth
- 密码加密: bcrypt (cost factor 10)
- 验证邮件: Supabase自动发送

**优先级**: P0 (Must Have)
**估算工作量**: 0.5天
**依赖**: 无

[... 更多用户故事]
```

---

## 6.3 验收标准(acceptance-criteria.md)定义

### 什么是验收标准?

**验收标准(Acceptance Criteria)**是判断用户故事是否完成的具体条件,通常使用**Given-When-Then**格式:

```
Given [前置条件]
When [用户操作]
Then [期望结果]
```

---

### Given-When-Then模板

**示例: 音频上传功能**

```markdown
# 验收标准: US-001 音频上传

## AC-001: 成功上传音频

**Given** 我已登录系统
**When** 我拖拽一个50MB的MP3文件到上传区域
**Then**
- 系统开始上传并显示进度条
- 进度条从0%逐渐增长到100%
- 上传完成后显示"上传成功!"提示
- 音频出现在"我的会议"列表中

**测试数据**: `tests/fixtures/sample-meeting-30min.mp3`

---

## AC-002: 文件格式错误

**Given** 我已登录系统
**When** 我尝试上传一个PDF文件
**Then**
- 系统拒绝上传
- 显示错误提示: "不支持的文件格式,请上传MP3、WAV或M4A文件"
- 错误提示是红色,带有错误图标
- 提供"重新选择文件"按钮

**测试数据**: `tests/fixtures/invalid-format.pdf`

---

## AC-003: 文件大小超限

**Given** 我已登录系统
**When** 我尝试上传一个300MB的音频文件
**Then**
- 系统拒绝上传
- 显示错误提示: "文件太大,请上传小于200MB的文件"
- 建议: "您可以使用音频编辑软件压缩文件后再上传"
- 提供"重新选择文件"按钮

**测试数据**: `tests/fixtures/large-file-300mb.mp3`

---

## AC-004: 网络中断重试

**Given** 我已登录系统,并开始上传一个100MB的文件
**When** 上传进行到50%时网络中断
**Then**
- 进度条停止,显示"上传失败: 网络连接中断"
- 提供"重试"按钮
- 点击"重试"后,从断点继续上传(而非从头开始)
- 最终上传成功

**测试方法**: 使用Chrome DevTools的Network throttling模拟网络中断

---

## AC-005: 并发上传限制

**Given** 我已登录系统
**When** 我同时拖拽3个音频文件到上传区域
**Then**
- 系统提示: "每次只能上传1个文件,请等待当前上传完成"
- 或者: 系统将3个文件加入队列,依次上传

**业务规则**: MVP阶段不支持并发上传(简化实现)

---

## AC-006: 未登录状态

**Given** 我未登录
**When** 我访问上传页面
**Then**
- 系统自动跳转到登录页面
- 登录成功后返回上传页面

---

## AC-007: 上传进度实时性

**Given** 我已登录系统并开始上传50MB文件
**When** 上传过程中
**Then**
- 进度条每1秒更新一次
- 显示已上传大小和总大小(例: "25MB / 50MB")
- 显示预计剩余时间(例: "预计还需30秒")
- 可以点击"取消上传"按钮中止

---

## 性能验收标准

| 指标 | 目标值 | 测量方法 |
|------|-------|---------|
| 上传速度 | > 1MB/s | 本地测试上传100MB文件,耗时 < 100秒 |
| UI响应 | < 100ms | 拖拽文件到显示进度条,延迟 < 100ms |
| 进度更新频率 | 1次/秒 | 观察进度条更新频率 |
| 取消上传响应 | < 500ms | 点击取消到上传停止,延迟 < 500ms |

---

## 边界条件测试

| 测试场景 | 输入 | 期望输出 |
|---------|------|---------|
| 最小文件 | 1KB MP3 | 成功上传,但转录可能失败(内容太短) |
| 最大文件 | 200MB MP3 | 成功上传 |
| 超大文件 | 201MB MP3 | 拒绝上传,错误提示 |
| 空文件 | 0KB MP3 | 拒绝上传,错误提示: "文件为空" |
| 特殊字符文件名 | `会议-2024/10/12.mp3` | 文件名自动sanitize为 `会议-2024-10-12.mp3` |
| 中文文件名 | `技术评审会.mp3` | 支持,正常上传 |
```

---

### BDD (行为驱动开发) 格式

**使用Gherkin语法**,便于自动化测试:

```gherkin
# features/audio-upload.feature

Feature: 音频文件上传
  作为Tech Lead
  我想要上传会议录音
  以便于系统可以转录和分析

  Background:
    Given 我已登录系统
    And 我在上传页面

  Scenario: 成功上传MP3文件
    When 我拖拽一个50MB的MP3文件到上传区域
    Then 我应该看到上传进度条
    And 进度条应该从0%增长到100%
    And 完成后应该显示"上传成功!"提示
    And 文件应该出现在"我的会议"列表中

  Scenario: 上传不支持的文件格式
    When 我尝试上传一个PDF文件
    Then 我应该看到错误提示"不支持的文件格式"
    And 提示应该包含支持的格式: MP3, WAV, M4A
    And 文件不应该被上传

  Scenario Outline: 文件大小验证
    When 我尝试上传一个<size>的音频文件
    Then 结果应该是<result>
    And 如果失败,应该显示<message>

    Examples:
      | size   | result | message |
      | 1MB    | 成功   | N/A |
      | 100MB  | 成功   | N/A |
      | 200MB  | 成功   | N/A |
      | 201MB  | 失败   | "文件太大,请上传小于200MB的文件" |
      | 300MB  | 失败   | "文件太大,请上传小于200MB的文件" |

  Scenario: 网络中断自动重试
    Given 我开始上传一个100MB的文件
    When 上传进行到50%时网络中断
    Then 应该显示"上传失败: 网络连接中断"
    And 应该提供"重试"按钮
    When 我点击"重试"
    Then 应该从断点继续上传
    And 最终上传应该成功
```

---

## 6.4 非功能需求识别

### 非功能需求的重要性

**为什么容易被忽略?**
- 💻 开发者更关注功能实现("能用就行")
- 📈 非功能需求难以量化和测试
- ⏱️ 时间压力下优先级降低

**忽略的后果**:
```
案例: 只关注功能,忽略性能
结果: MVP上线后,用户抱怨"太慢了,30分钟会议转录要1小时"
影响: 用户流失,口碑受损,需要紧急重构

案例: 只关注功能,忽略安全
结果: 用户A可以访问用户B的会议纪要
影响: 数据泄露,法律风险,公司声誉受损
```

---

### 非功能需求分类(FURPS+)

#### F - Functionality (功能性补充)

虽然是"非功能",但包含功能性的边界:

```markdown
## 国际化 (i18n)
- MVP: 仅支持英文
- v1.2: 支持中文、日文
- 语言切换: 用户设置页面,实时生效

## 可访问性 (Accessibility)
- 符合WCAG 2.1 AA标准
- 键盘导航: Tab键切换,Enter确认
- 屏幕阅读器: ARIA标签完整
- 颜色对比度: ≥ 4.5:1
- 字体大小: 最小16px,支持浏览器缩放

## 审计日志 (Audit Trail)
- 记录所有关键操作:
  - 用户登录/登出
  - 文件上传/删除
  - 纪要导出
- 日志保留: 90天
- 用途: 故障排查、安全审计
```

#### U - Usability (可用性)

```markdown
## 学习曲线
- 新用户5分钟内完成首次会议转录
- 每个功能都有inline help或tooltip
- 提供视频教程(3分钟快速入门)

## 错误处理
- 所有错误都有用户友好的提示
- 错误提示包含:
  - 问题描述: "上传失败"
  - 原因: "网络连接中断"
  - 解决方案: "请检查网络后点击重试"
- 技术错误代码仅在控制台显示,对用户隐藏

## 帮助系统
- 每个页面右下角有"帮助"按钮
- 点击打开相关帮助文章
- 搜索功能: 用户可以搜索常见问题

## 响应式设计
- Desktop (1920×1080): 完整功能
- Tablet (768×1024): 完整功能,布局调整
- Mobile (375×667): 核心功能(上传、查看纪要),部分功能隐藏到菜单
```

#### R - Reliability (可靠性)

```markdown
## 系统可用性
- 目标: 99.5% uptime (每月最多3.6小时停机)
- 依赖: Supabase (99.9% SLA), Vercel (99.99% SLA)
- 监控: Vercel Analytics实时监控
- 告警: 系统down超过5分钟发邮件告警

## 故障恢复
- RTO (Recovery Time Objective): < 1小时
- RPO (Recovery Point Objective): < 1小时
- 备份: Supabase自动每日备份,保留7天
- 灾难恢复: 使用Supabase备份手动恢复

## 数据完整性
- 音频文件使用checksum验证完整性
- 数据库使用PostgreSQL事务保证一致性
- 转录结果与原音频关联,防止数据丢失

## 错误率
- 目标: API调用成功率 > 99%
- 监控: Supabase Logs记录所有API调用
- 告警: 错误率超过5%发告警
```

#### P - Performance (性能)

```markdown
## 响应时间目标

| 操作 | P50 | P95 | P99 | 测量方法 |
|------|-----|-----|-----|---------|
| 页面加载 | < 1s | < 2s | < 3s | Lighthouse |
| 音频上传 | > 1MB/s | > 0.5MB/s | > 0.3MB/s | 实际上传测试 |
| 转录处理 | < 0.5x实时 | < 1x实时 | < 1.5x实时 | 后台任务监控 |
| AI提取 | < 15s | < 30s | < 45s | GPT-4 API响应时间 |
| API查询 | < 100ms | < 300ms | < 500ms | 数据库查询日志 |

## 并发能力
- 支持100并发用户无性能降级
- 支持10并发转录任务
- 数据库连接池: 20个连接(Supabase默认)

## 资源使用
- 前端Bundle大小: < 500KB (gzipped)
- 数据库存储: 每用户平均10MB (100个会议 × 100KB metadata)
- 文件存储: 每用户平均2GB (100个会议 × 20MB音频)

## 缓存策略
- 静态资源: CDN缓存,1年过期
- API响应: 不缓存(实时数据)
- 用户会议列表: 浏览器缓存5分钟
```

#### S - Supportability (可支持性)

```markdown
## 可维护性
- 代码规范: ESLint + Prettier自动检查
- 测试覆盖率: > 80%
- 文档: 所有public函数有JSDoc
- 代码复杂度: 圈复杂度 < 10

## 可监控性
- 日志级别: ERROR, WARN, INFO, DEBUG
- 日志存储: Supabase Logs, 保留30天
- 指标监控:
  - API调用次数和失败率
  - 转录任务成功率和处理时间
  - 用户活跃度
- Dashboard: Supabase Dashboard + Vercel Analytics

## 可调试性
- 所有错误都有唯一错误码
- 错误日志包含: 时间、用户ID、操作、错误详情、堆栈跟踪
- 开发环境有详细的debug日志

## 可扩展性
- 代码模块化,功能解耦
- 使用依赖注入,便于测试和替换
- API版本化,支持平滑升级
```

#### + - Additional Constraints (额外约束)

```markdown
## 法律合规
- GDPR: 用户可以请求删除所有数据
- CCPA: 提供数据导出功能
- 隐私政策: 明确说明数据使用方式
- 用户协议: 用户注册时需同意

## 部署约束
- 仅支持云部署(Vercel + Supabase)
- 不支持私有部署(MVP阶段)
- 服务器位置: 美国(Supabase US region)

## 成本约束
- MVP月度成本目标: < $100
- 单用户成本: < $2/月
- API调用成本: < $0.10/会议

## 技术约束
- 必须使用TypeScript (代码质量)
- 必须使用Supabase (快速开发)
- 必须使用React (团队熟悉度)
- 前端支持现代浏览器(Chrome 90+, Firefox 90+, Safari 14+)
```

---

## 6.5 本章小结

需求细化阶段的核心要点:

1. **PRD完善五个维度**:
   - 功能描述: 从抽象到具体,包含数据格式和API细节
   - 验收标准: 从主观到客观,可量化可测试
   - 技术实现: 从框架到代码级别,包含错误处理
   - 依赖关系: 功能依赖和技术依赖清晰标注
   - 非功能需求: 性能、安全、可用性全面补充

2. **用户故事编写(INVEST)**:
   - Independent: 独立性,减少依赖
   - Negotiable: 可协商,留出实现灵活性
   - Valuable: 有价值,从用户角度出发
   - Estimable: 可估算,具体可测
   - Small: 小型化,1-3天可完成
   - Testable: 可测试,明确验收标准

3. **验收标准定义**:
   - Given-When-Then格式清晰描述场景
   - 包含正常场景和异常场景
   - 性能指标量化(P50/P95/P99)
   - 边界条件全面测试

4. **非功能需求识别(FURPS+)**:
   - Functionality: 国际化、可访问性、审计
   - Usability: 学习曲线、错误处理、响应式
   - Reliability: 可用性99.5%、故障恢复、数据完整性
   - Performance: 响应时间、并发能力、资源使用
   - Supportability: 可维护、可监控、可调试、可扩展
   - Additional: 法律合规、部署约束、成本约束

**关键洞察**:
> "需求细化的目标是让AI能够'无歧义地理解'要实现什么。从'AI智能分析'到'使用GPT-4提取架构决策,格式为结构化JSON',这种细化程度才能驱动高质量的AI代码生成。"

**实践建议**:
1. **PRD细化**: 用3个问题检验每个功能:"输入是什么?处理逻辑是什么?输出是什么?"
2. **用户故事**: 用INVEST原则review每个故事,不符合就拆分或重写
3. **验收标准**: 每个故事至少3个AC(正常、异常、边界),并量化
4. **非功能需求**: 不要等到最后,而是在PRD阶段就明确所有NFR

**下一章**: 我们将学习技术栈选择的详细方法,包括如何选择AI友好的技术栈、Starter kit使用、测试框架配置,以及技术决策文档编写。

---

**思考题**:
1. 你的PRD中有多少功能描述是抽象的("AI分析")?能否用具体的输入、处理、输出来细化?
2. 你的用户故事是否符合INVEST原则?哪些需要拆分?
3. 你的项目是否明确了所有非功能需求?性能目标、安全标准、可用性要求是否量化?

👉 [下一章:技术栈选择](chapter7-tech-stack-selection.md)
